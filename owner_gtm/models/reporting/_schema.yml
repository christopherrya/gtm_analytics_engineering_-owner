version: 2

models:
  - name: rpt_funnel_summary
    description: >
      Full-funnel GTM summary by channel (Inbound vs Outbound).
      One row per channel with lead counts, conversion rates at each stage,
      win rates, loss category breakdowns, speed-to-lead metrics,
      decision maker connection rates, and prospect profile averages.
      This is the primary table for answering "where do we invest to scale 2-3x?"
    columns:
      - name: channel
        description: "Inbound or Outbound"
        tests:
          - unique
          - not_null
      - name: total_leads
        description: "Total leads in this channel"
      - name: converted_leads
        description: "Leads that converted to opportunities"
      - name: lead_to_opp_rate_pct
        description: "Lead-to-opportunity conversion rate (%)"
      - name: demo_rate_pct
        description: "Percentage of opportunities where a demo was held"
      - name: win_rate_pct
        description: "Win rate on closed deals (%)"
      - name: lead_to_win_rate_pct
        description: "End-to-end lead-to-closed-won rate (%)"
      - name: pre_demo_losses
        description: "Deals lost before demo was held"
      - name: process_losses
        description: "Deals lost due to non-responsiveness or lack of urgency"
      - name: competitive_losses
        description: "Deals lost to price or competitor"
      - name: product_fit_losses
        description: "Deals lost due to POS integration or bad fit"
      - name: avg_speed_to_lead_min
        description: "Average minutes to first sales contact (inbound only)"
      - name: avg_days_to_close_won
        description: "Average days to close for won deals"
      - name: avg_won_predicted_sales
        description: "Average predicted monthly sales for won deals"

  - name: rpt_monthly_unit_economics
    description: >
      Monthly unit economics by channel for Jan–Jun 2024.
      Combines GTM expenses with lead volumes and deal outcomes to calculate
      cost-per-lead, cost-per-opportunity, and CAC by channel.
      This is the primary table for answering "how do we improve CAC:LTV?"
    columns:
      - name: expense_month
        description: "Month as DATE"
        tests:
          - unique
          - not_null
      - name: total_gtm_cost
        description: "Total GTM spend for the month"
      - name: inbound_cac
        description: "Inbound customer acquisition cost (inbound channel cost / inbound wins)"
      - name: outbound_cac
        description: "Outbound customer acquisition cost (outbound channel cost / outbound wins)"
      - name: blended_cac
        description: "Blended CAC across both channels (total cost / total wins)"
      - name: inbound_cost_per_lead
        description: "Inbound channel cost divided by inbound leads generated"
      - name: outbound_cost_per_lead
        description: "Outbound channel cost divided by outbound leads generated"
      - name: inbound_won_predicted_revenue
        description: "Sum of predicted monthly sales for inbound closed-won deals"
      - name: outbound_won_predicted_revenue
        description: "Sum of predicted monthly sales for outbound closed-won deals"

  - name: rpt_cac_ltv_by_channel
    description: >
      CAC and LTV analysis by channel (Inbound vs Outbound).
      One row per channel. LTV is calculated as (monthly subscription + 5% take rate
      on predicted sales) x customer lifetime months. Since churn data is unavailable,
      LTV is shown at 12, 24, and 36 month horizons. CAC uses the full Jan-Jun 2024
      expense window. This is the primary table for evaluating channel investment efficiency.
    columns:
      - name: channel
        description: "Inbound or Outbound"
        tests:
          - unique
          - not_null
      - name: deals_won
        description: "Total closed-won deals for this channel"
      - name: total_cost_6mo
        description: "Total channel-allocated cost over Jan-Jun 2024"
      - name: cac
        description: "Customer acquisition cost (total channel cost / deals won)"
      - name: avg_monthly_subscription
        description: "Average monthly subscription fee per won deal ($500 flat)"
      - name: avg_monthly_take_rate
        description: "Average monthly take rate revenue per won deal (5% of predicted sales)"
      - name: avg_monthly_revenue
        description: "Average total monthly revenue per won deal (subscription + take rate)"
      - name: avg_ltv_12mo
        description: "Average LTV assuming 12-month customer lifetime"
      - name: avg_ltv_24mo
        description: "Average LTV assuming 24-month customer lifetime"
      - name: avg_ltv_36mo
        description: "Average LTV assuming 36-month customer lifetime"
      - name: ltv_to_cac_12mo
        description: "LTV:CAC ratio at 12-month horizon"
      - name: ltv_to_cac_24mo
        description: "LTV:CAC ratio at 24-month horizon"
      - name: ltv_to_cac_36mo
        description: "LTV:CAC ratio at 36-month horizon"

  - name: rpt_pipeline_health
    description: >
      Pre-aggregated pipeline health summary by channel and pipeline segment.
      One row per channel × record_type × pipeline_segment. Powers the Pipeline
      Health Dashboard with record counts, forecasted revenue, aging, risk/health
      distribution, and channel composition percentages.
    columns:
      - name: channel
        description: "Inbound or Outbound"
      - name: record_type
        description: "Opportunity or Lead"
      - name: pipeline_segment
        description: "Segment label (e.g. Early Pipeline, Active Lead, Near Close)"
      - name: record_count
        description: "Number of records in this segment"
      - name: pct_of_channel
        description: "Share of channel record count (%)"
      - name: total_forecasted_monthly_revenue
        description: "Sum of forecasted monthly revenue in segment"
      - name: total_forecasted_annual_revenue
        description: "Sum of forecasted annual revenue in segment"
      - name: pct_of_channel_revenue
        description: "Share of channel forecasted annual revenue (%)"
      - name: avg_days_in_pipeline
        description: "Average days records have been in pipeline"
      - name: avg_days_in_current_stage
        description: "Average days in current stage"
      - name: high_risk_pct
        description: "Percentage of segment at high loss risk"
      - name: medium_risk_pct
        description: "Percentage of segment at medium loss risk"
      - name: low_risk_pct
        description: "Percentage of segment at low loss risk"
      - name: ingest_ts
        description: "Report load timestamp (from audit_columns macro)"
      - name: update_ts
        description: "Report update timestamp (from audit_columns macro)"
      - name: source_system
        description: "Pipeline that produced the report (from audit_columns macro)"

  - name: rpt_lead_outreach_priority
    description: >
      Prioritized queue of unconverted working leads for sales outreach.
      One row per lead. Segments by outreach section (No Outreach / Slow Outreach),
      priority (P0–P2, Late/Very Late/Critically Late, Expired), and dashboard status
      (ACTION REQUIRED, RE-ENGAGE, MONITOR, EXPIRED, DATA QUALITY). Powers the
      Lead Outreach Priority / Speed-to-Lead dashboard.
    columns:
      - name: lead_id
        description: "Primary key - unique lead identifier"
        tests:
          - unique
          - not_null
      - name: outreach_section
        description: "No Outreach (no contact yet) or Slow Outreach (contacted late)"
      - name: outreach_priority
        description: "P0 Immediate, P2 At Risk, Expired, Late, Very Late, Critically Late, or Outbound - No Anchor Date"
      - name: dashboard_status
        description: "ACTION REQUIRED, RE-ENGAGE, MONITOR, EXPIRED — NURTURE, DATA QUALITY — NO ANCHOR, or REVIEW"
      - name: is_actionable
        description: "True if within 72hr window (no outreach) or in slow-outreach bucket requiring follow-up"
      - name: is_high_value_urgent
        description: "True for actionable no-outreach leads with predicted_sales_with_owner >= 5000"
      - name: channel
        description: "Inbound or Outbound"
      - name: working_lead_health
        description: "Active, Aging, or Stale (for working leads)"
      - name: predicted_sales_tier
        description: "Tier 1 ($10k+) through Tier 6 (Under $500)"
      - name: speed_to_lead_minutes
        description: "Minutes from form submission to first sales contact (inbound only)"
      - name: recommended_action
        description: "Operational recommendation text for the lead"

  - name: rpt_channel_efficiency
    description: >
      Monthly channel efficiency by channel (Inbound/Outbound) with rolling 3-month CAC,
      MoM deltas, threshold flags, and channel mix percentages. One row per channel × month.
      Powers the Channel Efficiency Monitor dashboard.
    columns:
      - name: channel
        description: "Inbound or Outbound"
      - name: expense_month
        description: "First of month as DATE"
      - name: new_leads
        description: "Leads generated in the month"
      - name: converted_leads
        description: "Leads that became opportunities"
      - name: deals_won
        description: "Closed-won deals in the month"
      - name: monthly_cac
        description: "CAC for the month (channel cost / deals won)"
      - name: rolling_3mo_cac
        description: "3-month rolling average CAC"
      - name: rolling_3mo_conversion_rate
        description: "3-month rolling win rate (of converted)"
      - name: cac_mom_pct_change
        description: "Month-over-month CAC percent change"
      - name: conversion_rate_mom_pct_change
        description: "Month-over-month conversion rate percent change"
      - name: pct_of_total_spend
        description: "This channel's share of total GTM spend (%)"
      - name: pct_of_total_wins
        description: "This channel's share of total wins (%)"
      - name: cac_threshold_flag
        description: "Healthy, Warning (>$2k), or Critical (>$3k) based on monthly CAC"
      - name: conversion_threshold_flag
        description: "Healthy, Warning (<15%), or Critical (<10%) based on win rate"
      - name: cac_trend
        description: "Stable, Improving, Deteriorating, or Insufficient Data vs rolling CAC"
      - name: efficiency_score
        description: "Composite efficiency metric (CAC / conversion rate)"
